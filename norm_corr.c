/*
 * norm_corr.c
 *
 *  Created on: 11.08.2018
 *      Author: fliess
 */

#include "norm_corr.h"
#include <math.h>
#include <string.h>
#include "commands.h"
#include <float.h>

// each sample must end with FLT_MAX as delimiter
const float push[] = { // push #1
		1811.2, 2003.9, 2103.8, 1532.4, 1511.5, 1585.8, 1859.6, 2073.4, 2249.4,
				2199.3, 1676.7, 1730.5, 1932.0, 2230.3, 2453.0, 2639.0, 2801.2,
				2875.9, 2541.6, 2209.0, 2429.5, 2732.2, 2963.3, 3138.0, 3259.3,
				3328.3, 3355.4, 3392.0, 3390.8, 3371.4, 3332.1, 3265.1, 3184.1,
				3183.4, 3090.7, 2630.7, 2190.4, 2372.8, 2549.5, 2736.1, 2777.8,
				2898.4, 3018.0, 3139.0, 2450.4, 2625.4, 2987.7, 3127.3, 3251.7,
				3481.9, 3629.3, 3743.7, 3828.0, 3877.1, 3895.5, 3900.9, 3910.1,
				3893.4, 3878.7, 3849.5, 3819.1, 3785.1, 3778.8, 3753.0, 3731.3,
				3714.8, 3704.0, 3683.6, 3657.2, 3647.5, 3662.6, 3638.0, 3635.5,
				3628.6, 3647.3, 3639.1, 3660.7, 3664.9, 3672.9, 3698.3, 3726.1,
				3779.6, 3814.5, 3881.7, 3905.9, 3964.6, 4064.3, 4178.0, 4304.5,
				4435.7, 4605.1, 4624.5, 4862.8, 5093.2, 5344.9, 5586.1, 5844.2,
				6149.8, 6203.9, 6466.8, 6786.2, 7106.1, 7421.1, 7743.4, 8068.8,
				8189.8, 8352.9, 8613.8, 8829.4, 9020.9, 9188.9, 9365.4, 9465.0,
				9506.7, 9639.5, 9721.5, 9718.4, 9671.8, 9584.9, 9492.4, 9476.5,
				9346.6, 9193.9, 9048.1, 8897.3, 8752.8, 8628.0, 8611.9, 8517.7,
				8410.3, 8320.6, 8245.0, 8182.6, 8169.5, 8171.9, 8206.1, 8263.2,
				8336.8, 8416.7, 8502.8, 8577.4, 8654.3, 8674.3, 8773.8, 8880.6,
				8960.3, 9020.4, 9053.0, 9053.7, 9053.0, 9043.5, 9014.3, 8965.8,
				8896.9, 8795.9, 8700.2, 8691.3, 8580.9, 8460.2, 8354.4, 8259.6,
				8192.9, 8160.4, 8143.6, 8132.1, 8129.7, 8162.0, 8247.3, 8339.4,
				8457.6, 8527.1, 8584.8, 8724.7, 8866.6, 9020.3, 9154.7, 9292.6,
				9425.9, 9449.9, 9607.2, 9779.7, 9959.4, 10141.3, 10347.7,
				10595.9, 10617.9, 10875.9, 11144.6, 11428.3, 11722.9, 12045.8,
				12359.2, 12459.2, 12661.6, 12885.5, 13055.5, 13131.0, 13170.1,
				13191.3, 13186.8, 13173.3, 13126.6, 13037.0, 12972.0, 12928.7,
				12886.5, 12854.4, 12846.6, 12794.5, 12768.3, 12775.0, 12812.8,
				12848.7, 12864.0, 12866.9, 12878.2, 12858.6, 12798.2, 12712.1,
				12603.6, 12479.2, 12438.1, 12348.3, 12231.7, 12154.7, 12096.5,
				12068.1, 12067.4, 12071.3, 12086.3, 12103.9, 12129.9, 12127.1,
				12095.3, 12039.7, 11998.4, 11996.9, 11973.2, 11938.6, 11894.7,
				11842.7, 11796.9, 11744.1, 11739.3, 11673.1, 11620.9, 11563.6,
				11503.6, 11456.2, 11416.8, 11406.2, 11371.3, 11329.8, 11308.2,
				11298.5, 11336.6, 11369.2, 11400.7, 11424.7, 11463.1, 11507.9,
				11595.7, 11709.3, 11832.2, 11919.4, 11934.4, 12009.1, 12097.8,
				12225.4, 12377.9, 12514.9, 12611.0, 12615.5, 12686.8, 12745.8,
				12870.5, 13029.6, 13192.9, 13355.7, 13402.4, 13554.7, 13806.8,
				14123.1, 14495.6, 14916.2, 15346.8, 15566.3, 15774.3, 16214.6,
				16628.0, 17006.6, 17332.6, 17624.6, 17781.3, 17828.9, 17950.8,
				18027.3, 18024.7, 17936.0, 17724.6, 17438.2, 17420.1, 17089.8,
				16748.9, 16394.2, 16043.9, 15678.0, 15313.4, 15225.4, 14960.2,
				14654.5, 14389.0, 14208.5, 14095.5, 14010.8, 13974.5, 13964.8,
				13936.5, 13920.0, 13907.0, 13898.9, 13899.4, 13883.8, 13889.5,
				13866.0, 13817.3, 13791.9, 13768.0, 13766.7, 13761.3, 13761.4,
				13759.0, 13754.3, 13728.4, 13683.6, 13651.5, 13612.9, 13608.4,
				13592.2, 13602.8, 13638.9, 13671.7, 13737.4, 13818.9, 13872.2,
				13933.5, 14043.3, 14192.7, 14385.6, 14621.5, 14864.7, 15022.4,
				15088.9, 15298.3, 15512.7, 15724.8, 15956.1, 16189.9, 16401.6,
				16415.6, 16626.5, 16832.3, 17047.2, 17284.4, 17516.4, 17718.9,
				17751.4, 17862.1, 17937.2, 17937.5, 17899.5, 17831.8, 17691.3,
				17613.8, 17481.9, 17198.0, 16876.2, 16531.0, 16182.3, 15876.8,
				15659.6, 15572.8, 15309.6, 15080.1, 14885.0, 14732.2, 14606.7,
				14534.9, 14529.0, 14497.2, 14515.5, 14568.1, 14645.5, 14719.9,
				14756.4, FLT_MAX,
				// push #2
				1.2, 2.1, 7.7, 7.8, 6.5, -2.0, -20.6, -61.1, -103.3, -130.7,
				-121.3, -106.7, -58.1, -7.2, 47.1, 102.0, 144.2, 190.0, 191.3,
				218.4, 264.8, 296.4, 346.6, 372.3, 404.6, 407.3, 448.6, 477.5,
				497.3, 545.4, 574.7, 576.0, 579.8, 586.0, 582.4, 549.0, 541.3,
				509.6, 555.9, 603.1, 665.5, 729.2, 765.8, 867.6, 918.4, 1026.3,
				1098.9, 1129.1, 1244.1, 1375.4, 1519.3, 1672.1, 1813.7, 1944.8,
				1952.5, 2046.8, 1564.8, 1553.0, 1862.7, 2160.9, 2412.6, 2438.9,
				2112.6, 2033.3, 2457.3, 2810.9, 3113.8, 3355.7, 3474.6, 3591.1,
				3791.1, 3974.8, 4132.4, 4282.8, 4422.2, 4519.2, 4557.2, 4689.7,
				4820.3, 4963.7, 5102.1, 5252.1, 5391.9, 5402.4, 5537.9, 5696.7,
				5851.1, 5996.6, 6110.3, 6231.9, 6254.8, 6342.7, 6461.4, 6554.8,
				6616.4, 6662.5, 6657.6, 6658.3, 6649.3, 6608.1, 6527.2, 6431.8,
				6295.6, 6146.9, 6031.5, 5986.0, 5808.8, 5642.3, 5508.4, 5408.2,
				5369.5, 5345.2, 5351.7, 5374.7, 5418.6, 5492.7, 5554.2, 5619.5,
				5706.5, 5721.0, 5771.4, 5837.3, 5890.8, 5951.2, 6005.4, 6060.3,
				6074.8, 6117.3, 6198.4, 6310.8, 6436.4, 6554.8, 6690.1, 6768.3,
				6819.5, 6925.3, 7008.2, 7063.5, 7131.1, 7189.0, 7223.8, 7229.3,
				7256.5, 7272.2, 7283.8, 7290.3, 7292.2, 7299.9, 7305.1, 7306.2,
				7359.0, 7427.0, 7516.8, 7631.6, 7781.0, 7861.3, 7995.2, 8233.6,
				8488.5, 8751.2, 9018.2, 9304.5, 9452.5, 9540.3, 9745.3, 9938.8,
				10132.2, 10315.2, 10475.2, 10589.6, 10606.8, 10671.5, 10656.6,
				10566.9, 10451.3, 10338.6, 10202.8, 10193.7, 10099.9, 10001.2,
				9910.6, 9833.4, 9750.2, 9693.0, 9677.0, 9638.7, 9570.9, 9526.0,
				9495.5, 9497.6, 9543.2, 9593.7, 9627.8, 9734.2, 9865.6, 10007.3,
				10142.0, 10260.7, 10319.4, 10324.3, 10380.0, 10382.0, 10356.0,
				10293.2, 10235.7, 10169.4, 10162.5, 10104.0, 10029.9, 9971.1,
				9919.1, 9875.1, 9878.5, 9883.0, 9904.6, 9952.1, 10010.0,
				10066.3, 10126.0, 10173.3, 10192.7, 10210.7, 10239.5, 10257.7,
				10258.0, 10216.5, 10155.5, 10104.2, 10090.4, 10015.6, 9962.5,
				9924.2, 9887.3, 9865.7, 9840.8, 9841.6, 9829.8, 9799.6, 9772.8,
				9744.9, 9714.6, 9712.4, 9723.8, 9717.8, 9721.6, 9728.9, 9759.0,
				9793.4, 9836.9, 9856.6, 9872.4, 9935.5, 10011.2, 10096.0,
				10171.7, 10267.8, 10356.9, 10380.1, 10527.3, 10708.9, 10906.5,
				11125.3, 11378.6, 11661.7, 11678.4, 11967.4, 12313.6, 12692.9,
				13109.7, 13567.1, 14017.9, 14147.3, 14440.8, 14806.3, 15141.6,
				15375.1, 15496.6, 15479.3, 15404.4, 15319.4, 15053.7, 14729.9,
				14353.1, 13941.2, 13505.1, 13155.4, 13057.2, 12626.1, 12230.7,
				11889.4, 11606.5, 11371.7, 11216.9, 11209.4, 11096.6, 11050.7,
				11049.1, 11082.1, 11145.5, 11231.2, 11251.7, 11319.9, 11418.8,
				11521.0, 11614.7, 11717.0, 11825.5, 11888.9, 11955.5, 12096.6,
				12240.7, 12371.3, 12491.4, 12625.7, 12697.1, 12736.2, 12854.0,
				12934.5, 13034.3, 13103.5, 13174.7, 13240.0, 13244.6, 13317.4,
				13371.9, 13412.7, 13423.4, 13424.0, 13410.1, 13404.6, 13399.4,
				13386.9, 13361.1, 13324.9, 13298.5, 13286.3, 13272.4, 13268.8,
				13236.3, 13219.9, 13183.5, 13161.7, 13127.4, 13097.3, 13084.0,
				13047.3, 13001.1, 12945.1, 12882.2, 12806.6, 12738.1, 12730.5,
				12646.2, 12537.5, 12417.3, 12298.6, 12178.0, 12042.2, 12015.0,
				11903.5, 11765.7, 11591.4, 11397.2, 11214.9, 11011.3, 10933.8,
				10843.8, FLT_MAX };

const int pushLenTotal = sizeof(push) / sizeof(float);
volatile int pushLenMax;
volatile int pushSamples;

float volatile rpmMax = 0;
float volatile loadTrend = 0;

void initCorrelation(void) {
	for (int i = 0; i < pushLenTotal; i++) {
		if (push[i] == FLT_MAX) {
			pushSamples++;
		}
	}
}

bool crossCorrelate(Queue* q, float* arr, int arrLen, float corrTres,
		int sampleIndex) {
	resetOffset(q);
	rpmMax = 0;

	float sum[AF_PUSH] = { 0 };
	float sumQ[AF_PUSH] = { 0 };
	float sumArr[AF_PUSH] = { 0 };
	float sq[AF_PUSH] = { 0 };
	int i[AF_PUSH] = { 0 };

//	float loadSum1 = 0;
//	int loadNum1 = 0;
//	float loadSum2 = 0;
//	int loadNum2 = 0;

	while (hasNext(q)) {
		float* pair = next(q);
		float qRpm = *pair; //rpm
		float qCurr = *(pair + 1); //current

		if (qRpm > rpmMax) {
			rpmMax = qRpm;
		}

//		if (q->remains <= LOAD_TREND_SAMPLES) {
//			if (q->remains > LOAD_TREND_SAMPLES / 2) {
//				loadSum1 += qCurr;
//				loadNum1++;
//			} else {
//				loadSum2 += qCurr;
//				loadNum2++;
//			}
//		}

		int j = 1;
		for (int n = 0; n < AF_PUSH; n++) {
			if (i[n] < arrLen) {
				sum[n] += qRpm * arr[i[n]];
				sumQ[n] += powf(qRpm, 2);
				sumArr[n] += powf(arr[i[n]], 2);
			}
			i[n] += j;
			j++;
		}
	}

//	loadTrend = loadSum2 / loadNum2 - loadSum1 / loadNum1;

	for (int n = 0; n < AF_PUSH; n++) {
		sq[n] = sqrtf(sumQ[n] * sumArr[n]);
		float corr = sum[n] / sq[n];
		if (corr >= corrTres) {
			commands_printf("%d - %d - %.2f", n, sampleIndex, corr);
			return true;
		}
	}
	return false;
}
